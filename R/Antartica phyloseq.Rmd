---
title: "Antarctica - ASV analysis "
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
---

# Initialize

## Libraries

```{r, echo=TRUE, message=FALSE, warning=FALSE}
   if(any(grepl("package:dvutils", search()))) detach("package:dvutils", unload=TRUE)
   library(dvutils)
   library(stringr)
   library(ggplot2)
   library(dplyr)
   library(tidyr)
   library(tibble)
   library(readr)
   library(maps)
   library(glue)
   
   library(phyloseq)

   # library(pr2database)
   # data("pr2")
```

## Markdown
```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               eval = TRUE)
opts_knit$set(width=75)
```

# Get the Antarctica ASVs


|set id |  description |
|---|---|
| 16 | Antar_2015_18S_V4 |
| 17 | Antar_2015_16S_plastid |
| 18 | Antar_2015_18S_V4_sorted |
	
* Only use asv for which supergroup_boot >= 90

```{r, message=FALSE}
  rm(list = ls())
  sample_type <- c("18S filter", "16S plastid", "18S sort")
  
  asv <- list()
  ps <- list()
  long <- list()
# Export as specific data set as a phyloseq file
  
  i <- 16
  for (one_sample_type in sample_type) {
      asv[[one_sample_type]] <- metapr2_export_asv(dataset_id_selected = i, 
                                                   export_phyloseq = FALSE, 
                                                   export_xls = FALSE,
                                                   boot_min = 90, 
                                                   boot_level = supergroup_boot,
                                                   directory = "../dada2/") 

      ps[[one_sample_type]] <- asv[[one_sample_type]][["ps"]]
  # Label samples with date 
      sample_data(ps[[one_sample_type]])$sample_label <- as.character(sample_data(ps[[one_sample_type]])$date)
      
  # Add TFF to sample name
      # sample_data(ps[[one_sample_type]])$sample_label <- str_c(sample_data(ps[[one_sample_type]])$metadata_code, 
      #                                                          str_replace_na(sample_data(ps[[one_sample_type]])$sample_concentration, ""), 
      #                                                          sep = "." )
      
      print(glue("Phyloseq - {one_sample_type}"))
      print(ps[[one_sample_type]] )
      cat("============================\n")
      
  i <- i + 1
  
  }
  
  
  sample_variables(ps[["18S filter"]])
  
  rm(asv)

```


# Filtration

* Only use Station 6 (not 14)
* Only surface considered (5 m)
* Do not consider TFF samples 
* Only keep photosynthetic groups abd exclude dinoflagellates
* Very important, must remove taxa that are not present in the filtered samples

```{r}
  for (one_sample_type in sample_type) {

      ps[[one_sample_type]] <- ps[[one_sample_type]] %>% 
        subset_taxa((division %in% c("Chlorophyta", "Cryptophyta", "Rhodophyta","Haptophyta", "Ochrophyta")) |
                    (class == "Filosa-Chlorarachnea")) %>% 
        subset_samples(station_id=="6") %>% 
        subset_samples(depth_level=="surface") %>% 
        subset_samples(is.na(sample_concentration)) %>%
        filter_taxa(function(x) sum(x) > 0 , TRUE)
      
      
      print(glue("Phyloseq - {one_sample_type}"))
      print(ps[[one_sample_type]] )
      cat("============================\n")
      
  }

```
# Get the different fraction separately

```{r, message=FALSE}


  fraction_filter <- c(0.2, 3, 20)
  fraction_sort <- c("pico", "nano")
  
  sample_type_filtered <- c(str_c(sample_type[1], fraction_filter, "um", sep=" "), 
                            str_c(sample_type[2], fraction_filter, "um", sep=" "),
                            str_c(sample_type[3], fraction_sort, sep=" "))
  
# Export as specific data set as a phyloseq file
  
  for (one_sample_type in sample_type[1:2]) {
    for (one_fraction in fraction_filter) {
      one_sample_type_filtered <- c(str_c(one_sample_type, one_fraction, "um", sep=" "))
      ps[[one_sample_type_filtered]] <- ps[[one_sample_type]] %>% 
        subset_samples(fraction_min == one_fraction) %>% 
        filter_taxa(function(x) sum(x) > 0 , TRUE)
      
      print(glue("Phyloseq - {one_sample_type_filtered}"))
      print(ps[[one_sample_type_filtered]] )
      cat("============================\n")
    }
  
  }
  
# Sorted samples
  
    for (one_sample_type in sample_type[3]) {
    for (one_fraction in fraction_sort) {
      one_sample_type_filtered <- c(str_c(one_sample_type, one_fraction, sep=" "))
      ps[[one_sample_type_filtered]] <- ps[[one_sample_type]] %>% 
        subset_samples(fraction_name == one_fraction) %>% 
        filter_taxa(function(x) sum(x) > 0 , TRUE)
      
      print(glue("Phyloseq - {one_sample_type_filtered}"))
      print(ps[[one_sample_type_filtered]] )
      cat("============================\n")
    }
  
    }
  
  sample_type_all <- c(sample_type, sample_type_filtered)
  

```

# Normalize and transform to long form

```{r, message=FALSE}

  for (one_sample_type in sample_type_all) {
    
      cat(one_sample_type)
      cat("\n============================")  
      
      ps[[one_sample_type]] <- phyloseq_normalize_median(ps[[one_sample_type]])
      
      long[[one_sample_type]] <- phyloseq_transform_to_long(ps[[one_sample_type]])
      
      cat("\n") 
      
  }


```


# Treemaps


```{r fig.height=6, fig.width=6}

  treemap_class <- list()
  treemap_genus <- list()
  
  for (one_sample_type in sample_type_all) {
    
      treemap_class[[one_sample_type]] <- phyloseq_long_treemap(long[[one_sample_type]], 
                                                                     division, class, 
                                                                     str_c(one_sample_type, " - Class" ))
      treemap_genus[[one_sample_type]] <- phyloseq_long_treemap(long[[one_sample_type]], 
                                                                     class, genus, 
                                                                     str_c(one_sample_type, " - Genus" ))
 
  }

```

# ASVs bargraphs


```{r, fig.height=8, fig.width=8}



  bargraph_asv <- list()
  bargraph_species <- list()
  
  for (one_sample_type in sample_type_all) {
    
      bargraph_asv [[one_sample_type]] <- phyloseq_long_bargraph(long[[one_sample_type]], text_scaling = 0.75,n_bars = 20, use_asv = TRUE, 
                                                                title = one_sample_type)
      bargraph_species[[one_sample_type]] <- phyloseq_long_bargraph(long[[one_sample_type]], text_scaling = 0.75,n_bars = 20 ,use_asv = FALSE, 
                                                                title = one_sample_type)

  }


```
# Barplots per sample

```{r fig.height=8, fig.width=8}

  bargraph_sample <- list()

  for (one_sample_type in sample_type_all[4:11]) { 
    
    bargraph_sample[[one_sample_type]] <- plot_bar(ps[[one_sample_type]], x = "sample_label", fill = "class") + 
        geom_bar(aes(color = class, fill = class), stat = "identity", position = "stack") + 
        ggtitle(str_c("Class level - ", one_sample_type)) + theme(axis.text.y = element_text(size = 10)) + 
        theme(axis.text.x = element_text(angle = 0, hjust = 0.5)) + coord_flip() + 
        scale_fill_viridis_d() + scale_color_viridis_d()
    print(bargraph_sample[[one_sample_type]])
}
```

# Heatmaps (using the 10% most abundant taxa)

## Define function
```{r}
phyloseq_keep_abundant <- function(ps,contrib_min=0.1){
     total_per_sample <- max(sample_sums(ps))
     ps <- filter_taxa(ps, function(x) sum(x > total_per_sample*contrib_min) > 0, TRUE)
     ps <- phyloseq_normalize_median(ps)
     return(ps)
}
```


## Class
```{r fig.height=6, fig.width=9}
  heatmap_class <- list()

  for (one_sample_type in sample_type_all[4:11]) { 
    
    ps_heat <- tax_glom(ps[[one_sample_type]],taxrank = "class") %>% 
      phyloseq_keep_abundant(contrib_min=0.1)
      
    heatmap_class[[one_sample_type]]  <- plot_heatmap(ps_heat, method = "NMDS", distance = "bray", 
                 taxa.label = "class",  taxa.order="division",
                 sample.label = "sample_label", sample.order="sample_label",
                 low="beige", high="red", na.value="beige", 
                 title=one_sample_type)
    
    # plot(heatmap(otu_table(ps_heat)))
    
    print(heatmap_class[[one_sample_type]] )
  
  }
```

## Genus
```{r fig.height=6, fig.width=9}
  heatmap_genus <- list()

  for (one_sample_type in sample_type_all[4:11]) { 
    
    ps_heat <- tax_glom(ps[[one_sample_type]],taxrank = "genus") %>% 
      phyloseq_keep_abundant(contrib_min=0.1)
      
    heatmap_genus[[one_sample_type]]  <- plot_heatmap(ps_heat, method = "NMDS", distance = "bray", 
                 taxa.label = "genus",  taxa.order="division",
                 sample.label = "sample_label", sample.order="sample_label",
                 low="beige", high="red", na.value="beige", 
                 title=one_sample_type)
    
    print(heatmap_genus[[one_sample_type]] )
  
  }
```



# Figures

## Figure 2

```{r fig.height=30, fig.width=15}

treemap_18S_filt <- cowplot::plot_grid(treemap_class[["18S filter 0.2 um"]]$gg,
                                       treemap_class[["18S filter 3 um"]]$gg,
                                       treemap_class[["18S filter 20 um"]]$gg, 
                                       ncol=1)

treemap_18S_sort <- cowplot::plot_grid(treemap_class[["18S sort pico"]]$gg,
                                       treemap_class[["18S sort nano"]]$gg, 
                                       ncol=1)

treemap_16S_filt <- cowplot::plot_grid(treemap_class[["16S plastid 0.2 um"]]$gg,
                                       treemap_class[["16S plastid 3 um"]]$gg,
                                       treemap_class[["16S plastid 20 um"]]$gg, 
                                       ncol=1)

fig_2 <- cowplot::plot_grid(bargraph_species[["18S filter"]]$gg, treemap_18S_filt,
                            bargraph_species[["18S sort"]]$gg, treemap_18S_sort,
                            bargraph_species[["16S plastid"]]$gg, treemap_16S_filt,
                            ncol=2,rel_widths = c(2,1))

fig_2
```

